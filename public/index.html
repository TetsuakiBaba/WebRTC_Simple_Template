<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>WebRTC Chat</title>

</head>

<body>
    <div class="container">
        <div class="row">
            <h1>WebRTC Chat</h1>
            <div class="col-4">
                local
                <video class="img-fluid" id="localVideo" autoplay muted playsinline></video>
            </div>
            <div class="col-4">
                remote
                <video class="img-fluid" id="remoteVideo" autoplay playsinline></video>
            </div>

            <div class="col-4">
                <div id="chat">
                    <div id="messages"></div>
                    <input type="text" id="messageInput" placeholder="Type a message..." />
                    <button id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        let localStream;
        let remoteStream = new MediaStream();
        let peerConnection;
        let dataChannel;

        const configuration = {
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        };

        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                socket.emit('ready');
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        }

        socket.on('offer', async (offer) => {
            console.log('Received offer:', offer);
            await createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', answer);
        });

        socket.on('answer', async (answer) => {
            console.log('Received answer:', answer);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('candidate', async (candidate) => {
            console.log('Received candidate:', candidate);
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        });

        socket.on('ready', async () => {
            if (!peerConnection) {
                await createPeerConnection();
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', offer);
            }
        });

        async function createPeerConnection() {
            if (peerConnection) return;

            console.log('Creating peer connection');
            peerConnection = new RTCPeerConnection(configuration);

            dataChannel = peerConnection.createDataChannel("chat");
            dataChannel.onmessage = (event) => {
                const message = document.createElement('div');
                message.textContent = `Remote: ${event.data}`;
                messages.appendChild(message);
            };

            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                dataChannel.onmessage = (event) => {
                    const message = document.createElement('div');
                    message.textContent = `Remote: ${event.data}`;
                    messages.appendChild(message);
                };
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending candidate:', event.candidate);
                    socket.emit('candidate', event.candidate);
                }
            };

            peerConnection.ontrack = (event) => {
                console.log('Received remote track:', event.streams);
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
                remoteVideo.srcObject = remoteStream;
            };

            localStream.getTracks().forEach(track => {
                console.log('Adding local track:', track);
                peerConnection.addTrack(track, localStream);
            });
        }

        sendButton.onclick = () => {
            const message = messageInput.value;
            dataChannel.send(message);
            const messageElement = document.createElement('div');
            messageElement.textContent = `You: ${message}`;
            messages.appendChild(messageElement);
            messageInput.value = '';
        };

        init();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
</body>

</html>